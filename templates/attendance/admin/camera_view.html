{% extends "attendance/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block head %}
<style>
.camera-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 15px;
    min-height: 480px;
}
.camera-feed {
    width: 100%;
    height: 600px;
    border: none;
    background: #000;
    object-fit: contain;
}
.human-dot {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid white;
    z-index: 1000;
    animation: pulse 2s infinite;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white; 
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.human-dot.head { background: #dc3545; border-color: #fff; }
.human-dot.torso { background: #28a745; border-color: #fff; }
.human-dot.lower { background: #007bff; border-color: #fff; }
@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(255,255,255,0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
}
#webcamCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
}
</style>
{% endblock head %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-3">
        <div class="col-md-8">
            <h2><i class="fas fa-video me-2"></i>{{ camera.name }}</h2>
            <p class="text-muted">{{ camera.location }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('camera_management.cameras') }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Back to Cameras</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9">
            <div class="camera-container" id="cameraContainer">
                {% if is_webcam %}
                <video id="webcamVideo" class="camera-feed" autoplay playsinline muted></video>
                <canvas id="webcamCanvas"></canvas>
                <div id="webcamError" class="alert alert-danger m-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error accessing webcam. Please check your camera permissions.
                </div>                {% else %}
                <iframe id="cameraFeed" src="{{ url_for('camera_management.proxy_camera_stream', camera_id=camera_id) }}?direct=1" class="camera-feed" allow="camera; microphone" allowfullscreen></iframe>
                <canvas id="ipCameraCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></canvas>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Controls</h5>
                </div>
                <div class="card-body">
                    <button id="trackHumansBtn" class="btn btn-success btn-lg w-100 mb-3">
                        <i class="fas fa-users me-2"></i>Track Humans
                    </button>
                    <button id="stopTrackingBtn" class="btn btn-danger btn-lg w-100 mb-3 d-none">
                        <i class="fas fa-stop me-2"></i>Stop Tracking
                    </button>
                    
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center mb-2">
                            <span id="detectionStatusIndicator" class="status-indicator status-inactive"></span>
                            <span id="detectionStatusText">Detection Inactive</span>
                        </div>
                        <div class="small">Humans detected: <span id="humanCounter">0</span></div>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showTrails">
                        <label class="form-check-label" for="showTrails">Show movement trails</label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="emergencyTestDot">
                        <label class="form-check-label" for="emergencyTestDot">Show emergency test dots</label>
                    </div>
                    
                    <div id="detectionInfo" class="detection-info d-none">
                        <small class="fw-bold">Detection Active</small><br>
                        <small>Duration: <span id="detectionDuration">00:00</span></small><br>
                        <small>Last Update: <span id="lastUpdate">-</span></small>
                    </div>
                </div>
            </div>
            
            <!-- Camera Credentials Section -->
            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-key me-2"></i>Camera Credentials</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">URL:</small><br>
                        <small class="font-monospace">{{ camera.url }}</small>
                    </div>
                    
                    <div class="mb-2">
                        <label for="cameraUsername" class="form-label">Username:</label>
                        <input type="text" class="form-control form-control-sm" id="cameraUsername" 
                               value="{{ camera.username or '' }}" placeholder="Enter username">
                    </div>
                    
                    <div class="mb-3">
                        <label for="cameraPassword" class="form-label">Password:</label>
                        <input type="password" class="form-control form-control-sm" id="cameraPassword" 
                               value="{{ camera.password or '' }}" placeholder="Enter password">
                    </div>
                    
                    <button id="updateCredentialsBtn" class="btn btn-warning btn-sm w-100 mb-2">
                        <i class="fas fa-save me-2"></i>Update Credentials
                    </button>
                    
                    <button id="testConnectionBtn" class="btn btn-info btn-sm w-100 mb-2">
                        <i class="fas fa-plug me-2"></i>Test Connection
                    </button>
                      <button id="refreshStreamBtn" class="btn btn-secondary btn-sm w-100 mb-2">
                        <i class="fas fa-refresh me-2"></i>Refresh Stream
                    </button>
                      <button id="discoverStreamsBtn" class="btn btn-success btn-sm w-100 mb-2">
                        <i class="fas fa-search me-2"></i>Find Video Stream
                    </button>
                    
                    <button id="showEndpointsBtn" class="btn btn-outline-info btn-sm w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#commonEndpoints">
                        <i class="fas fa-list me-2"></i>Common Endpoints
                    </button>
                    
                    <div class="collapse" id="commonEndpoints">
                        <div class="card card-body mt-2 p-2">
                            <small class="text-muted">
                                <strong>DVR/NVR Systems:</strong><br>
                                ‚Ä¢ /cam/realmonitor?channel=1&subtype=0<br>
                                ‚Ä¢ /videostream.cgi?channel=1<br>
                                ‚Ä¢ /streaming/channels/1/preview<br>
                                ‚Ä¢ /ISAPI/Streaming/channels/1/preview<br>
                                ‚Ä¢ /cgi-bin/snapshot.cgi?channel=1<br><br>
                                
                                <strong>Generic IP Cameras:</strong><br>
                                ‚Ä¢ /mjpeg<br>
                                ‚Ä¢ /video.cgi<br>
                                ‚Ä¢ /snapshot.cgi<br>
                                ‚Ä¢ /image.jpg<br><br>
                                
                                <small class="text-primary">
                                    <i class="fas fa-info-circle"></i> 
                                    Click "Find Video Stream" to test these automatically
                                </small>
                            </small>
                        </div>
                    </div>
                    
                    <div id="connectionStatus" class="mt-2"></div>
                    
                    <!-- Stream Discovery Results -->
                    <div id="streamDiscoveryResults" class="mt-3" style="display: none;">
                        <h6>Discovered Streams:</h6>
                        <div id="streamsList" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- MediaPipe Scripts for Human Detection -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

<script src="{{ url_for('static', filename='attendance/js/camera-human-detection.js') }}"></script>

<!-- Initialize Human Detection System -->
<script>
window.addEventListener('DOMContentLoaded', function() {
    // Initialize the camera human detection system from the imported script
    if (typeof window.initializePoseDetection === 'function') {
        console.log('Found initializePoseDetection, initializing...');
        window.initializePoseDetection()
            .then(poseDetector => {
                console.log('Pose detector initialized successfully:', poseDetector);
                window.poseDetector = poseDetector;
            })
            .catch(err => {
                console.error('Failed to initialize pose detector:', err);
            });
    } else {
        console.warn('initializePoseDetection not found in global scope');
    }
});</script>

<script>
// Camera view controller
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Camera view loaded');
      // Initialize the camera human detector
    const isWebcam = {% if is_webcam %}true{% else %}false{% endif %};
    const cameraId = "{{ camera_id }}";
    
    // Log the camera type for debugging
    console.log('üéØ CameraHumanTracker initialized for: ' + (isWebcam ? 'Webcam' : 'IP Camera'));
    
    class CameraHumanTracker {
        constructor() {
            this.isTracking = false;
            this.detectionStartTime = null;
            this.humanCount = 0;
            this.trackingInterval = null;
            this.poseDetection = null;
            this.mediaPipeReady = false;
            this.lastFrameData = null;
            this.simulationState = false;
            this.lastSimulationTime = null;
            this.isWebcam = isWebcam;
            
            this.container = document.getElementById('cameraContainer');
            this.webcamVideo = document.getElementById('webcamVideo');
            this.webcamCanvas = document.getElementById('webcamCanvas');
            this.ipCameraCanvas = document.getElementById('ipCameraCanvas');
            this.isWebcam = isWebcam;
            
            console.log('üéØ CameraHumanTracker initialized for:', this.isWebcam ? 'Webcam' : 'IP Camera');
            
            this.initializeControls();
            this.initializeMediaPipe();
            
            if (this.isWebcam) {
                this.initializeWebcam();
            }

            // Emergency test dot checkbox handler
            const emergencyDotCheckbox = document.getElementById('emergencyTestDot');
            if (emergencyDotCheckbox) {
                emergencyDotCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.showEmergencyTestDots();
                    } else {
                        this.clearDetectionDots();
                    }
                });
            }
        }
        
        initializeControls() {
            // Setup tracking button
            const trackBtn = document.getElementById('trackHumansBtn');
            const stopBtn = document.getElementById('stopTrackingBtn');
            
            if (trackBtn && stopBtn) {                trackBtn.addEventListener('click', () => {
                    console.log('üéØ Track Humans button clicked!');
                    this.startTracking();
                    trackBtn.classList.add('d-none');
                    stopBtn.classList.remove('d-none');
                });
                
                stopBtn.addEventListener('click', () => {
                    this.stopTracking();
                    stopBtn.classList.add('d-none');
                    trackBtn.classList.remove('d-none');
                });
            }
        }        async initializeMediaPipe() {
            try {
                // Use the global pose detector if available
                if (window.poseDetector) {
                    console.log('‚úÖ Using already initialized pose detector');
                    this.poseDetection = window.poseDetector;
                    this.mediaPipeReady = true;
                    return;
                }
                
                // Wait for the camera-human-detection.js to be fully loaded
                let attempts = 0;
                const maxAttempts = 20;
                
                while (attempts < maxAttempts) {
                    if (window.CameraHumanDetector && window.CameraHumanDetector.initializePoseDetection) {
                        console.log('üéØ Found CameraHumanDetector.initializePoseDetection');
                        this.poseDetection = await window.CameraHumanDetector.initializePoseDetection();
                        this.mediaPipeReady = !!this.poseDetection;
                        console.log('‚úÖ MediaPipe initialized via CameraHumanDetector:', this.mediaPipeReady);
                        return;
                    } else if (window.initializePoseDetection) {
                        console.log('üéØ Found global initializePoseDetection');
                        this.poseDetection = await window.initializePoseDetection();
                        this.mediaPipeReady = !!this.poseDetection;
                        console.log('‚úÖ MediaPipe initialized via global:', this.mediaPipeReady);
                        return;
                    }
                    
                    console.log(`‚è≥ Waiting for pose detection... attempt ${attempts + 1}/${maxAttempts}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                console.warn('‚ö†Ô∏è MediaPipe initialization timeout, creating fallback');
                // Create a fallback pose detector for simulation
                this.poseDetection = {
                    process: async (videoElement) => {
                        return { landmarks: [] }; // Empty landmarks for fallback
                    }
                };
                this.mediaPipeReady = false;
                console.log('üîÑ Created fallback pose detector');
            } catch (err) {
                console.error('‚ùå Error initializing MediaPipe:', err);
                this.mediaPipeReady = false;
            }
        }
        
        async initializeWebcam() {
            if (!this.webcamVideo) return;
            
            try {
                console.log('üé• Requesting webcam access...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                // Stop any existing stream before assigning a new one
                if (this.webcamVideo.srcObject) {
                    const tracks = this.webcamVideo.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // Set new stream to video element
                this.webcamVideo.srcObject = stream;
                
                if (document.getElementById('webcamError')) {
                    document.getElementById('webcamError').style.display = 'none';
                }
                
                // Setup canvas size to match video
                this.webcamVideo.addEventListener('loadedmetadata', () => {
                    if (this.webcamCanvas) {
                        this.webcamCanvas.width = this.webcamVideo.videoWidth;
                        this.webcamCanvas.height = this.webcamVideo.videoHeight;
                        console.log(`üñºÔ∏è Set canvas size to ${this.webcamCanvas.width}x${this.webcamCanvas.height}`);
                    }
                });
            } catch (err) {
                console.error('Error accessing webcam:', err);
                if (document.getElementById('webcamError')) {
                    document.getElementById('webcamError').style.display = 'block';
                }
            }
        }
          startTracking() {
            console.log('üöÄ StartTracking called, isTracking:', this.isTracking);
            if (this.isTracking) return;
            
            // Initialize tracking state
            this.isTracking = true;
            this.detectionStartTime = Date.now();
            console.log('üìä Tracking initialized, isWebcam:', this.isWebcam);
            
            // Update UI
            const statusIndicator = document.getElementById('detectionStatusIndicator');
            const statusText = document.getElementById('detectionStatusText');
            const detectionInfo = document.getElementById('detectionInfo');
            
            if (statusIndicator) {
                statusIndicator.classList.remove('status-inactive');
                statusIndicator.classList.add('status-active');
            }
            if (statusText) {
                statusText.innerText = 'Detection Active';
            }
            if (detectionInfo) {
                detectionInfo.classList.remove('d-none');
            }
            
            // Start detection loop
            if (this.isWebcam && this.webcamVideo && this.webcamCanvas) {
                console.log('üé• Starting webcam detection loop');
                this.trackingInterval = setInterval(() => this.detectHumans(), 100);
            } else {
                console.log('üì° Starting IP camera simulation loop');
                this.trackingInterval = setInterval(() => this.simulateDetection(), 100);
            }
            
            // Start duration timer
            this.durationInterval = setInterval(() => this.updateDuration(), 1000);
            
            this.showToast('Human detection started');
            console.log('‚úÖ Tracking started successfully');
        }
        
        stopTracking() {
            if (!this.isTracking) return;
            
            // Clean up tracking
            this.isTracking = false;
            if (this.trackingInterval) {
                clearInterval(this.trackingInterval);
                this.trackingInterval = null;
            }
            
            // Update UI
            document.getElementById('detectionStatusIndicator').classList.remove('status-active');
            document.getElementById('detectionStatusIndicator').classList.add('status-inactive');
            document.getElementById('detectionStatusText').innerText = 'Detection Inactive';
            document.getElementById('detectionInfo').classList.add('d-none');
            
            // Clear any detection markers
            this.clearDetectionDots();
            
            this.showToast('Human detection stopped');
        }
        
        async detectHumans() {
            if (!this.isTracking || !this.mediaPipeReady) {
                this.simulateDetection(); // Fall back to simulation if MediaPipe not ready
                return;
            }
            
            try {
                // Draw video to canvas for detection
                const ctx = this.webcamCanvas.getContext('2d');
                ctx.drawImage(this.webcamVideo, 0, 0, this.webcamCanvas.width, this.webcamCanvas.height);
                
                // Detect poses with MediaPipe
                if (this.poseDetection && this.poseDetection.detectForCanvas) {
                    const poses = await this.poseDetection.detectForCanvas(this.webcamCanvas);
                    this.clearDetectionDots();
                    
                    if (poses && poses.length > 0) {
                        let humanCount = 0;
                        
                        poses.forEach(pose => {
                            // Check confidence threshold
                            if (pose.score >= 0.2) {
                                humanCount++;
                                
                                // Extract key landmarks for head, torso, lower body
                                const head = pose.keypoints.find(kp => kp.name === 'nose');
                                const torso = pose.keypoints.find(kp => kp.name === 'mid_hip');
                                const lower = pose.keypoints.find(kp => kp.name === 'ankle_left') || 
                                              pose.keypoints.find(kp => kp.name === 'ankle_right');
                                
                                // Add detection dots for each part if available
                                if (head && head.score > 0.5) {
                                    this.addDetectionDot('head', 
                                        head.x / this.webcamCanvas.width * 100, 
                                        head.y / this.webcamCanvas.height * 100);
                                }
                                
                                if (torso && torso.score > 0.5) {
                                    this.addDetectionDot('torso', 
                                        torso.x / this.webcamCanvas.width * 100, 
                                        torso.y / this.webcamCanvas.height * 100);
                                }
                                
                                if (lower && lower.score > 0.5) {
                                    this.addDetectionDot('lower', 
                                        lower.x / this.webcamCanvas.width * 100, 
                                        lower.y / this.webcamCanvas.height * 100);
                                }
                            }
                        });
                        
                        // Update human count
                        this.humanCount = humanCount;
                        document.getElementById('humanCounter').innerText = humanCount;
                        
                        // Update last detection time
                        const now = new Date();
                        document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();
                    } else {
                        // No humans detected
                        this.humanCount = 0;
                        document.getElementById('humanCounter').innerText = '0';
                    }
                } else {
                    // MediaPipe not ready, fallback to simulation
                    this.simulateDetection();
                }
            } catch (error) {
                console.error('Error in human detection:', error);
                this.simulateDetection(); // Fallback on error
            }
        }          simulateDetection() {
            if (!this.isTracking) return;
            
            // Create simulated detection data
            const now = Date.now();
            if (!this.lastSimulationTime) this.lastSimulationTime = now;
            
            // Only update every 200ms to create smooth animation
            if (now - this.lastSimulationTime < 200) return;
            this.lastSimulationTime = now;
            
            console.log('ü§ñ Running simulation detection...');
            
            // Clear previous dots
            this.clearDetectionDots();
            
            // If emergency test dots are enabled, show them
            const emergencyTestCheckbox = document.getElementById('emergencyTestDot');
            if (emergencyTestCheckbox && emergencyTestCheckbox.checked) {
                console.log('üî¥ Showing emergency test dots');
                this.showEmergencyTestDots();
                return;
            }
            
            // More realistic simulation - keep the human count more stable
            if (!this.simulatedHumanCount) {
                // Initialize between 1-3 humans for more realistic simulation
                this.simulatedHumanCount = Math.floor(Math.random() * 3) + 1;
                console.log('üë• Initialized simulation with', this.simulatedHumanCount, 'humans');
            } else {
                // Occasionally change the count (5% chance)
                if (Math.random() < 0.05) {
                    const change = Math.random() < 0.5 ? 1 : -1;
                    this.simulatedHumanCount = Math.max(0, Math.min(4, this.simulatedHumanCount + change));
                    console.log('üë• Changed human count to', this.simulatedHumanCount);
                }
            }
            
            this.humanCount = this.simulatedHumanCount;
            const humanCounterElement = document.getElementById('humanCounter');
            if (humanCounterElement) {
                humanCounterElement.innerText = this.humanCount;
            }
            
            // Add detection dots for each simulated human with more realistic distributions
            for (let i = 0; i < this.humanCount; i++) {
                // Calculate some movement using sine/cosine for natural motion
                const timeOffset = now / 1000 + i * Math.PI / 2;
                
                // Each human gets a different area of the screen
                const baseX = 20 + (i * 20);
                const baseY = 40 + (i % 2) * 20;
                
                // Add some natural movement patterns
                const centerX = baseX + Math.sin(timeOffset * 0.5) * 8;
                const centerY = baseY + Math.cos(timeOffset * 0.3) * 5;
                
                // Add head, torso, lower dots with slight offsets
                this.addDetectionDot('head', centerX, centerY - 10);
                this.addDetectionDot('torso', centerX, centerY);
                this.addDetectionDot('lower', centerX, centerY + 15);
            }
            
            // Update last detection time
            const updateTime = new Date();
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.innerText = updateTime.toLocaleTimeString();
            }
            
            console.log('‚úÖ Simulation detection completed, added', this.humanCount, 'humans');
        }
        
        showEmergencyTestDots() {
            console.log('üî¥ Showing emergency test dots');
            this.clearDetectionDots();
            
            // Add a grid of dots to verify positioning
            const testPositions = [
                { type: 'head', x: 10, y: 10, label: '1' },
                { type: 'torso', x: 50, y: 10, label: '2' },
                { type: 'lower', x: 90, y: 10, label: '3' },
                { type: 'head', x: 10, y: 50, label: '4' },
                { type: 'torso', x: 50, y: 50, label: '5' },
                { type: 'lower', x: 90, y: 50, label: '6' },
                { type: 'head', x: 10, y: 90, label: '7' },
                { type: 'torso', x: 50, y: 90, label: '8' },
                { type: 'lower', x: 90, y: 90, label: '9' }
            ];
            
            testPositions.forEach(pos => {
                this.addDetectionDot(pos.type, pos.x, pos.y, pos.label);
            });
        }
        
        addDetectionDot(type, x, y, label = '') {
            if (!this.container) return;
            
            try {
                const dot = document.createElement('div');
                dot.className = `human-dot ${type}`;
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                if (label) dot.innerText = label;
                this.container.appendChild(dot);
            } catch (error) {
                console.error('‚ùå Error adding detection dot:', error);
            }
        }
        
        clearDetectionDots() {
            if (!this.container) return;
            
            const dots = this.container.querySelectorAll('.human-dot');
            dots.forEach(dot => dot.remove());
        }
        
        updateDuration() {
            if (!this.detectionStartTime) return;
            
            const elapsed = Date.now() - this.detectionStartTime;
            const seconds = Math.floor((elapsed / 1000) % 60).toString().padStart(2, '0');
            const minutes = Math.floor((elapsed / (1000 * 60)) % 60).toString().padStart(2, '0');
            
            const durationElement = document.getElementById('detectionDuration');
            if (durationElement) {
                durationElement.textContent = minutes + ':' + seconds;
            }
        }
        
        showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-primary border-0 show';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.minWidth = '200px';
            toast.style.zIndex = '1050';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    }
    
    // Create and start the tracker
    window.tracker = new CameraHumanTracker();
    console.log('üéâ Camera interface fully loaded!');
    
    // Camera Credentials Management
    const updateCredentialsBtn = document.getElementById('updateCredentialsBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const refreshStreamBtn = document.getElementById('refreshStreamBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    
    if (updateCredentialsBtn) {
        updateCredentialsBtn.addEventListener('click', async function() {
            const username = document.getElementById('cameraUsername').value.trim();
            const password = document.getElementById('cameraPassword').value.trim();
            
            try {
                updateCredentialsBtn.disabled = true;
                updateCredentialsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                
                const response = await fetch(`/admin/api/cameras/{{ camera_id }}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    connectionStatus.innerHTML = '<div class="alert alert-success alert-sm">‚úÖ Credentials updated successfully!</div>';
                    
                    // Auto-refresh stream after credential update
                    setTimeout(() => {
                        refreshStreamBtn.click();
                    }, 1000);
                } else {
                    connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Error: ${result.message}</div>`;
                }
            } catch (error) {
                connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Network error: ${error.message}</div>`;
            } finally {
                updateCredentialsBtn.disabled = false;
                updateCredentialsBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Credentials';
            }
        });
    }
    
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', async function() {
            const username = document.getElementById('cameraUsername').value.trim();
            const password = document.getElementById('cameraPassword').value.trim();
            
            try {
                testConnectionBtn.disabled = true;
                testConnectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
                
                const response = await fetch(`/admin/api/cameras/{{ camera_id }}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    connectionStatus.innerHTML = '<div class="alert alert-success alert-sm">‚úÖ Connection test successful!</div>';
                } else {
                    connectionStatus.innerHTML = `<div class="alert alert-warning alert-sm">‚ö†Ô∏è Connection failed: ${result.message}</div>`;
                }
            } catch (error) {
                connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Test failed: ${error.message}</div>`;
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
            }
        });
    }    if (refreshStreamBtn) {
        refreshStreamBtn.addEventListener('click', function() {
            const iframe = document.getElementById('cameraFeed');
            if (iframe) {
                refreshStreamBtn.disabled = true;
                refreshStreamBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
                
                // Add timestamp to force refresh - properly handle existing query parameters
                const currentSrc = iframe.src;
                const url = new URL(currentSrc);
                url.searchParams.set('refresh', Date.now().toString());
                iframe.src = url.toString();
                
                connectionStatus.innerHTML = '<div class="alert alert-info alert-sm">üîÑ Stream refreshed</div>';
                
                setTimeout(() => {
                    refreshStreamBtn.disabled = false;
                    refreshStreamBtn.innerHTML = '<i class="fas fa-refresh me-2"></i>Refresh Stream';
                }, 2000);
            }
        });
    }
    
    // Stream discovery functionality
    const discoverStreamsBtn = document.getElementById('discoverStreamsBtn');
    const streamDiscoveryResults = document.getElementById('streamDiscoveryResults');
    const streamsList = document.getElementById('streamsList');
    
    if (discoverStreamsBtn) {
        discoverStreamsBtn.addEventListener('click', async function() {
            try {
                discoverStreamsBtn.disabled = true;
                discoverStreamsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Discovering...';
                
                connectionStatus.innerHTML = '<div class="alert alert-info alert-sm">üîç Scanning for video stream endpoints...</div>';
                
                const response = await fetch(`/admin/api/cameras/{{ camera_id }}/discover-streams`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.streams.length > 0) {
                    // Display discovered streams
                    streamsList.innerHTML = '';
                    
                    result.streams.forEach((stream, index) => {
                        const streamItem = document.createElement('div');
                        streamItem.className = 'list-group-item list-group-item-action p-2';
                        streamItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">${stream.endpoint}</small><br>
                                    <span class="badge bg-success">${stream.content_type}</span>
                                </div>
                                <button class="btn btn-sm btn-primary use-stream-btn" data-url="${stream.url}">
                                    Use This Stream
                                </button>
                            </div>
                        `;
                        streamsList.appendChild(streamItem);
                    });
                    
                    // Add event listeners to "Use This Stream" buttons
                    document.querySelectorAll('.use-stream-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const newUrl = this.getAttribute('data-url');
                            
                            try {
                                // Update camera URL
                                const updateResponse = await fetch(`/admin/api/cameras/{{ camera_id }}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        url: newUrl
                                    })
                                });
                                
                                const updateResult = await updateResponse.json();
                                
                                if (updateResult.success) {
                                    connectionStatus.innerHTML = '<div class="alert alert-success alert-sm">‚úÖ Camera URL updated! Refreshing stream...</div>';
                                    
                                    // Refresh the iframe with new URL
                                    setTimeout(() => {
                                        const iframe = document.getElementById('cameraFeed');
                                        if (iframe) {
                                            iframe.src = `/admin/proxy/camera/{{ camera_id }}?direct=1&t=${Date.now()}`;
                                        }
                                    }, 1000);
                                    
                                    // Hide discovery results
                                    streamDiscoveryResults.style.display = 'none';
                                } else {
                                    connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Failed to update camera URL: ${updateResult.message}</div>`;
                                }
                            } catch (error) {
                                connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Error updating camera: ${error.message}</div>`;
                            }
                        });
                    });
                    
                    streamDiscoveryResults.style.display = 'block';
                    connectionStatus.innerHTML = `<div class="alert alert-success alert-sm">üéâ Found ${result.streams.length} video stream(s)! Click "Use This Stream" to apply.</div>`;
                    
                } else if (result.success && result.streams.length === 0) {
                    connectionStatus.innerHTML = `<div class="alert alert-warning alert-sm">‚ö†Ô∏è No video streams found. Tested ${result.total_tested} common endpoints.</div>`;
                    streamDiscoveryResults.style.display = 'none';
                } else {
                    connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Discovery failed: ${result.error}</div>`;
                    streamDiscoveryResults.style.display = 'none';
                }
                
            } catch (error) {
                connectionStatus.innerHTML = `<div class="alert alert-danger alert-sm">‚ùå Network error: ${error.message}</div>`;
                streamDiscoveryResults.style.display = 'none';
            } finally {
                discoverStreamsBtn.disabled = false;
                discoverStreamsBtn.innerHTML = '<i class="fas fa-search me-2"></i>Find Video Stream';
            }
        });
    }
});
</script>
{% endblock scripts %}
